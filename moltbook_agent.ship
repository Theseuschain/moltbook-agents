// Moltbook Social Agent - Autonomous posting and engagement
//
// This agent runs hourly (every 600 blocks @ 6s/block) to participate
// in Moltbook, the social network for AI agents.
//
// See README.md for configuration and customization.

#[agent(name = "MoltbookAgent", version = 1, ship = "1.0", schedule = 600)]

const MODEL_ID: bytes32 = 0xe49630ccb59348a9cbbd9989e6774e8b7340b347fbcd94da1f535fb25c15f117;

// Moltbook API key - identifies this agent on Moltbook
// NOTE: This is visible on-chain. For production, consider alternative auth mechanisms.
const API_KEY: string = "moltbook_sk_BcMKQ9DaIV4cySo7ctZwIwmwbRMRmZ-y";

// Load identity and knowledge from markdown files
const SOUL: string = include!("./soul.md");
const SKILL: string = include!("./skill.md");
const HEARTBEAT: string = include!("./heartbeat.md");

// Tool response structure
struct MoltbookResponse {
    success: bool,
    data?: any,
    error?: string
}

// Tools - api_key is passed to authenticate with Moltbook
// We use 'any' type which allows for flexible input parameters.
// Alternatively, you could user defined structs for the parameters/body.
tool moltbook_get(endpoint: string, api_key: string, params?: any) -> MoltbookResponse;
tool moltbook_post(endpoint: string, api_key: string, body: any) -> MoltbookResponse;


#[entry]
node start(prompt: string) {   
    // Identity - who you are (permanent system context)
    messages.push(system(SOUL));
        
    messages.push(user(`API Reference: ${SKILL}
     Your Moltbook API key: ${API_KEY} Always include this as the api_key parameter in moltbook_get and moltbook_post calls.
    `));
    
    // Trigger
    if (caller() == self.address) {
        // Scheduled run - agent triggered itself
        messages.push(user(`Begin your scheduled check-in: ${HEARTBEAT}`));
    } else if (caller() == self.owner) {
        // Owner triggered via extrinsic
        messages.push(user(prompt));
    } else {
        // Some other account called us
        raise("Only the owner can trigger this agent");
    }
    // messages.push(user(HEARTBEAT + "Begin your scheduled check-in. Write a fresh post, do not comment on other user's posts. AVOID the general submolt. Do not search for submolts, use m/ai m/thinkingsystems m/intelligence"));

    goto(think);
}

#[model]
node think() {
    let out = model(MODEL_ID)
        .tools([moltbook_get, moltbook_post])
        .invoke(messages);
    
    messages.push(out);
    
    if (out.tool_calls) {
        goto(act);
    }
}

#[tool, handle_errors]
node act() {
    let results = tools.dispatch(messages.last());
    messages.push(results);
    
    // Continue thinking to process results and decide next action
    goto(think);
}
